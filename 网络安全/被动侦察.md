# 介绍
在这个房间里，在我们定义被动侦察和主动侦察之后，我们重点讨论与被动侦察相关的基本工具。我们将学习三个命令行工具：

- **whois查询 WHOIS 服务器**

- **nslookup查询 DNS 服务器**

- **dig查询 DNS 服务器**

我们使用whois来查询 WHOIS 记录，而我们使用nslookup和dig来查询 DNS 数据库记录。这些都是公开的记录，因此不会提醒目标。

我们还将学习两种在线服务的用法：

- **DNS垃圾箱**

- **Shodan.io**

这两项在线服务使我们能够收集有关目标的信息，而无需直接连接到目标。

# 被动侦察与主动侦察
侦察（recon）可以定义为收集目标信息的初步调查。这是统一杀伤链中在系统上获得初始立足点的第一步。我们将侦察分为：

**被动侦察**和**主动侦察**

## 被动侦察

例如：
- 从公共 DNS 服务器查找域的 DNS 记录。
- 检查与目标网站相关的招聘广告。
- 阅读有关目标公司的新闻文章。

## 主动侦察

例子：

- 连接到公司服务器之一，例如 HTTP、FTP 和 SMTP。
- 致电公司试图获取信息（社会工程）。
- 冒充修理工进入公司场所。

# Whois
WHOIS 是遵循RFC 3912规范的请求和响应协议。WHOIS 服务器在 TCP 端口 43 上侦听传入请求。域名注册商负责维护其租赁域名的 WHOIS 记录。WHOIS 服务器回复与请求的域相关的各种信息。特别有趣的是，我们可以了解到：
注册商：
- 域名是通过哪个注册商注册的？
- 注册人的联系信息：姓名、组织、地址、电话等。（除非通过隐私服务隐藏）
- 创建、更新和到期日期：域名首次注册是什么时候？上次更新是什么时候？以及什么时候需要更新？
- 名称服务器：请求哪个服务器来解析域名？

语法为：`whois 域名`

以下是实例：
```
user@TryHackMe$ whois tryhackme.com
[Querying whois.verisign-grs.com]
[Redirected to whois.namecheap.com]
[Querying whois.namecheap.com]
[whois.namecheap.com]
Domain name: tryhackme.com
Registry Domain ID: 2282723194_DOMAIN_COM-VRSN
Registrar WHOIS Server: whois.namecheap.com
Registrar URL: http://www.namecheap.com
Updated Date: 2021-05-01T19:43:23.31Z
Creation Date: 2018-07-05T19:46:15.00Z
Registrar Registration Expiration Date: 2027-07-05T19:46:15.00Z
Registrar: NAMECHEAP INC
Registrar IANA ID: 1068
Registrar Abuse Contact Email: abuse@namecheap.com
Registrar Abuse Contact Phone: +1.6613102107
Reseller: NAMECHEAP INC
Domain Status: clientTransferProhibited https://icann.org/epp#clientTransferProhibited
Registry Registrant ID: 
Registrant Name: Withheld for Privacy Purposes
Registrant Organization: Privacy service provided by Withheld for Privacy ehf
[...]
URL of the ICANN WHOIS Data Problem Reporting System: http://wdprs.internic.net/
>>> Last update of WHOIS database: 2021-08-25T14:58:29.57Z <<<
For more information on Whois status codes, please visit https://icann.org/epp
```
我们可以看到很多信息；我们将按照显示的顺序检查它们。首先，我们注意到我们被重定向到whois.namecheap.com以获取我们的信息。在这种情况下，目前namecheap.com正在维护该域名的 WHOIS 记录。此外，我们可以看到创建日期以及最后更新日期和到期日期。

接下来，我们获取有关注册商和注册人的信息。我们可以找到注册者的姓名和联系信息，除非他们使用某些隐私服务。尽管上面没有显示，但我们获得了该域的管理员和技术联系人。最后，如果我们有任何 DNS 记录要查找，我们会看到应该查询的域名服务器。

可以检查收集的信息以发现新的攻击面，例如社会工程或技术攻击。例如，根据渗透测试的范围，您可能会考虑对管理员用户的电子邮件服务器或 DNS 服务器进行攻击，假设它们归您的客户所有并且属于渗透测试的范围。

值得注意的是，由于自动化工具滥用 WHOIS 查询来获取电子邮件地址，因此许多 WHOIS 服务都采取了措施来解决这一问题。例如，他们可能会编辑电子邮件地址。此外，许多注册者订阅隐私服务，以避免他们的电子邮件地址被垃圾邮件发送者收集并保持他们的信息私密。

# nslookup 和 dig

在上一个任务中，我们使用 `WHOIS` 协议来获取有关我们正在查找的域名的各种信息。特别是，我们能够从注册商处获取 DNS 服务器。

使用`nslookup`(Name Server Look Up)查找域名的 IP 地址。您需要发出命令`nslookup DOMAIN_NAME`，例如nslookup tryhackme.com。或者，更一般地，您可以使用`nslookup OPTIONS`和`DOMAIN_NAME SERVER`. 这三个主要参数是：

OPTIONS 包含查询类型，如下表所示。例如，您可以用于AIPv4 地址和AAAAIPv6 地址。
DOMAIN_NAME 是您正在查找的域名。
SERVER是您要查询的DNS服务器。您可以选择任何本地或公共 DNS 服务器进行查询。Cloudflare 提供1.1.1.1和1.0.0.1，Google 提供8.8.8.8和8.8.4.4，Quad9 提供9.9.9.9和149.112.112.112。如果您想要替代 ISP 的 DNS 服务器，还有更多公共 DNS 服务器可供选择。
| 参数 | 结果
| --- | ---
| A | IPv4 地址
| AAAA | IPv6 地址
| CNAME |	Canonical Name
| MX | 邮件服务器
| SOA | Start of Authority
| TXT | TXT Records
例如，`nslookup -type=A tryhackme.com 1.1.1.1`或者`nslookup -type=a tryhackme.com 1.1.1.1`（因为它不区分大小写）可用于返回 tryhackme.com 使用的所有 IPv4 地址。
```
user@TryHackMe$ nslookup -type=A tryhackme.com 1.1.1.1
Server:		1.1.1.1
Address:	1.1.1.1#53

Non-authoritative answer:
Name:	tryhackme.com
Address: 172.67.69.208
Name:	tryhackme.com
Address: 104.26.11.229
Name:	tryhackme.com
Address: 104.26.10.229
```
假设您想了解特定域的电子邮件服务器和配置。您可以发出`nslookup -type=MX tryhackme.com`. 例子如下：
```
user@TryHackMe$ nslookup -type=MX tryhackme.com
Server:		127.0.0.53
Address:	127.0.0.53#53

Non-authoritative answer:
tryhackme.com	mail exchanger = 5 alt1.aspmx.l.google.com.
tryhackme.com	mail exchanger = 1 aspmx.l.google.com.
tryhackme.com	mail exchanger = 10 alt4.aspmx.l.google.com.
tryhackme.com	mail exchanger = 10 alt3.aspmx.l.google.com.
tryhackme.com	mail exchanger = 5 alt2.aspmx.l.google.com.
```
我们可以看到tryhackme.com当前的电子邮件配置使用Google。由于 MX 正在查找邮件交换服务器，我们注意到，当邮件服务器尝试发送电子邮件`@tryhackme.com`时，它将尝试连接到顺序为 1 的`aspmx.l.google.com` 。如果繁忙或不可用，邮件服务器将尝试连接到下一个邮件交换服务器，`alt1.aspmx.l.google.com`或`alt2.aspmx.l.google.com`。

Google 提供列出的邮件服务器；因此，我们不应期望邮件服务器运行易受攻击的服务器版本。但是，在其他情况下，我们可能会发现邮件服务器未得到充分保护或修补。

当您继续对目标进行被动侦察时，这些信息可能会很有价值。您可以对其他域名重复类似的查询并尝试不同的类型，例如`-type=txt`. 谁知道您一路上会发现什么样的信息！

对于更高级的 DNS 查询和附加功能，如果您好奇，可以使用`dig`（Domain Information Groper）的缩写。让我们用来`dig`查找 MX 记录并将它们与`nslookup`进行对比. 我们可以使用`dig DOMAIN_NAME`，但要指定记录类型，我们将使用`dig DOMAIN_NAME TYPE`。或者，我们可以使用 选择我们想要查询的服务器`dig @SERVER DOMAIN_NAME TYPE`。

- SERVER是您要查询的DNS服务器。
- DOMAIN_NAME 是您正在查找的域名。
- TYPE 包含 DNS 记录类型，如前面提供的表中所示。
```
user@TryHackMe$ dig tryhackme.com MX

; <<>> DiG 9.16.19-RH <<>> tryhackme.com MX
;; global options: +cmd
;; Got answer:
;; ->>HEADER<
```
`nslookup`和`dig`输出之间的快速比较说明`dig`可以返回更多信息，例如默认情况下的 TTL（生存时间）。如果你想查询1.1.1.1DNS 服务器，可以执行`dig @1.1.1.1 tryhackme.com MX`.

# DNSDumpster
DNS查询工具（如nslookup和dig）无法单独查找子域。您要调查的域可能包含多个子域，这些子域可能包含关于目标的重要信息。举例来说，如果tryhackme.com有子域wiki.tryhackme.com和webmail.tryhackme.com，您可能希望深入了解这些子域，因为它们可能包含有关目标的关键信息。这些子域中的某一个可能已经设置，但未定期更新，这通常会导致服务存在漏洞。但是，我们如何知道是否存在这些子域呢？

我们可以考虑使用多个搜索引擎来编制公开子域名的列表。一个搜索引擎可能不足以，需要多个搜索引擎的协同作用。此外，我们可能需要查看数十个结果才能找到有趣的信息，毕竟，我们寻找的是未经明确宣传的子域，它们通常不会显示在搜索结果的前几页。另一种发现这些子域的方法是进行暴力查询，以查找具有DNS记录的子域。

为了避免进行繁琐的搜索，人们可以使用在线服务，例如DNSDumpster，该服务提供了有关DNS查询的详细答案。如果我们在DNSDumpster上搜索tryhackme.com，我们将获得通常的DNS查询无法提供的子域信息，如blog.tryhackme.com。此外，DNSDumpster会以易于阅读的表格和图形形式返回所收集的DNS信息。DNSDumpster还会将域名解析为IP地址，并尝试对其进行地理定位。我们还可以查看MX记录；DNSDumpster会将所有五个邮件交换服务器解析为各自的IP地址，并提供有关所有者和位置的详细信息。最后，我们还可以查看TXT记录。实际上，进行一次查询就足以检索到所有这些信息。
![image](https://github.com/GODSLEEP/THM-/assets/37927545/a8f10f44-97a7-4076-b092-b35b21f83770)
DNSDumpster 还将以图形方式表示收集到的信息。DNSDumpster 将之前表中的数据显示为图表。您可以看到 DNS 和 MX 分支到各自的服务器，并且还显示 IP 地址。
![image](https://github.com/GODSLEEP/THM-/assets/37927545/ae0520ff-dac1-4af8-94b9-f30e60791ab1)
目前有一个测试版功能，允许您导出图表。如果需要，您可以操纵图表并移动块。
![image](https://github.com/GODSLEEP/THM-/assets/37927545/cca90bf5-2c77-4e78-a28a-8cc79fc2cb55)

# Shodan.io
当您负责针对特定目标运行渗透测试时，作为被动侦察阶段的一部分，像Shodan.io这样的服务可以帮助您了解有关客户端网络的各种信息，而无需主动连接到它。此外，在防御方面，您可以使用 Shodan.io 的不同服务来了解属于您组织的已连接和公开的设备。

Shodan.io 试图连接到每一个可在线访问的设备，以构建一个连接“事物”的搜索引擎，这与网页的搜索引擎不同。一旦收到响应，它就会收集与服务相关的所有信息并将其保存在数据库中以使其可搜索。
![image](https://github.com/GODSLEEP/THM-/assets/37927545/1c9f64f7-1deb-430e-9566-a7b146593168)
该记录显示了一个Web服务器；然而，正如已经提到的，Shodan.io 收集与其可以找到的在线连接的任何设备相关的信息。在 Shodan.io 上搜索tryhackme.com至少会显示上面截图中所示的记录。通过 Shodan.io 搜索结果，我们可以了解到与我们的搜索相关的一些信息，例如：
- IP地址
- 托管公司
- 地理位置
- 服务器类型和版本

#  总结
在这个房间里，我们专注于被动侦察。我们特别介绍了命令行工具 、`whois`、`nslookup`和`dig`。我们还讨论了两个公开可用的服务DNSDumpster和Shodan.io。此类工具的强大之处在于，您可以收集有关目标的信息，而无需直接连接到它们。此外，一旦您掌握了搜索选项并习惯了阅读结果，使用此类工具可能会找到大量信息。
| 目的 | 命令行示例
| --- | ---
| 查询WHOIS记录	| whois tryhackme.com
|查找 DNS A 记录 | nslookup -type=A tryhackme.com
|在 DNS 服务器上查找 DNS MX 记录	| nslookup -type=MX tryhackme.com 1.1.1.1
|查找 DNS TXT 记录 | nslookup -type=TXT tryhackme.com
|查找 DNS A 记录 | dig tryhackme.com A
|在 DNS 服务器上查找 DNS MX 记录	| dig @1.1.1.1 tryhackme.com MX
|查找 DNS TXT 记录 | dig tryhackme.com TXT

(完)
原文链接：https://tryhackme.com/room/passiverecon
